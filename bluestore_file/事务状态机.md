### æ¦‚è¿°
`queue_transaction()`æ˜¯ObjectStoreå±‚çš„ç»Ÿä¸€å…¥å£ï¼Œå„ä¸ªå­˜å‚¨å¼•æ“éƒ½éœ€è¦å®ç°è¿™ä¸ªå…¥å£ã€‚`TransContext`çš„`state_t state`å˜é‡è®°å½•äº†å½“å‰æ—¶åˆ»äº‹åŠ¡å¤„äºå“ªä¸ªçŠ¶æ€ã€‚çŠ¶æ€æœºä¸­æ¶‰åŠåˆ°ioä¿åºã€å»¶è¿Ÿå†™å’Œç®€å•å†™çš„æäº¤ã€kvdbæ•°æ®çš„æ›´æ–°ç­‰æ“ä½œï¼Œæ˜¯æ§åˆ¶bluestoreä¸­æ•°æ®è½ç›˜çš„å¹•åé»‘æ‰‹ã€‚`_write()`å‡½æ•°å®é™…ä¸è¿‡æ˜¯çœŸæ­£å†™æ“ä½œçš„å‰ç½®å·¥ä½œï¼Œwriteä»…ä»…è¡¨ç¤ºå…¶æ“ä½œå«ä¹‰æ˜¯å†™æˆ–æ”¹å†™ä¸€ä¸ªå¯¹è±¡ã€‚åæ–‡ä»‹ç»çš„æ‰€æœ‰å¯¹è±¡ã€pgæ“ä½œçš„çœŸæ­£è½ç›˜ç¯èŠ‚éƒ½æ˜¯åœ¨æ­¤å‡½æ•°ä¸­ã€‚çŠ¶æ€æœºä¹Ÿæ˜¯ä¸€æ¬¡queue_transactionçš„æœ€åä¸€æ­¥ï¼Œå½“ç¨‹åºè·³å‡ºçŠ¶æ€æœºä¹Ÿå°±æ„å‘³ç€è¿™æ¬¡ioå†™æ“ä½œå®Œæˆã€‚
éœ€è¦æ³¨æ„æ˜¯ï¼ŒçŠ¶æ€æœºä¸­ç”¨åˆ°å¤§é‡å¼‚æ­¥çº¿ç¨‹ï¼Œå› æ­¤å‰ç«¯åœ¨queue_transactionæ—¶ï¼Œæ— éœ€ç­‰åˆ°æ•´ä¸ªçŠ¶æ€æœºåˆ°è¾¾å®ŒæˆçŠ¶æ€ã€‚ä¸€èˆ¬ç›´æ¥å†™åœ¨STATE_PREPAREä¸­è°ƒç”¨`bdev->aio_submit()`åå°±è¿”å›å‰ç«¯ï¼Œå»¶è¿Ÿå†™åœ¨STATE_AIO_WAITä¸­è°ƒç”¨`_txc_finish_io()`è¿›è¡Œä¿åºå¤„ç†ï¼ˆæ ¹æ®osré¡ºåºä¾æ¬¡è¿›å…¥çŠ¶æ€æœºå¤„ç†ï¼‰åç›´æ¥è¿”å›å‰ç«¯ã€‚

åœ¨`queue_transaction()`ä¸­åˆ›å»ºå¹¶åˆå§‹åŒ–`TransContext`æ—¶ï¼Œä¼šå°†`state`åˆå§‹åŒ–ä¸º`STATE PREPARE`ï¼ˆåœ¨TransContextå®šä¹‰æ—¶è®¾ç½®çš„åˆå§‹å€¼ï¼‰ã€‚
![[Pasted image 20230207094940.png]]
æ­¤æ—¶ä¼šè°ƒç”¨`txc_add_transaction()`å°†OSDå±‚é¢çš„äº‹åŠ¡è½¬æ¢ä¸ºBlueStoreå±‚é¢çš„äº‹åŠ¡ã€‚çŠ¶æ€æœºçš„å¤„ç†åœ¨`_txc_state_proc()`ä¸­è¿›è¡Œã€‚

![[Pasted image 20230214173208.png]]

å¯¹äºsimple writeåœºæ™¯ï¼Œå…ˆæŠŠæ•°æ®å†™å…¥æ–°çš„blockï¼Œç„¶åå°†å…ƒæ•°æ®å†™åˆ°kvdbã€‚
![[Pasted image 20230214173550.png]]
å¯¹äºdeferred writeåœºæ™¯ï¼Œä¸éœ€è¦è€ƒè™‘aioï¼Œæ•°æ®å’Œå…ƒæ•°æ®å‡ä¸ºå†™kvdbï¼Œä½†æœ€åä»è¦å°†æ•°æ®ä»dbå†™å›blockï¼Œå¹¶åˆ é™¤dbä¸­çš„è®°å½•ã€‚
ï¼ˆå†™æ•°æ®ã€å…ƒæ•°æ®åˆ°db -> å†™æ•°æ®åˆ°block -> åˆ é™¤æ•°æ®æ—¥å¿—å¹¶æ›´æ–°dbï¼‰
![[Pasted image 20230214173610.png]]

### ä¸åŒçŠ¶æ€æœºçš„å¤„ç†

#### ğŸ“STATE_PREPARE
æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„io
ï¼ˆå¦‚æœ`_write()`ä¸­è¿›è¡Œè¿‡simple writeçš„å¤„ç†ï¼Œå¹¶è°ƒç”¨äº†`aio_write()`ï¼Œä¹Ÿåªæ˜¯å‡†å¤‡ioï¼Œioæäº¤æ“ä½œåœ¨æ­¤æ­¥è¿›è¡Œï¼‰ã€‚

- **simple write**
è‹¥æœ‰ï¼ˆsimple writeä¸€å®šæœ‰ï¼‰ï¼Œå°†stateè®¾ç½®ä¸º==**STATE_AIO_WAIT**==ï¼Œå¹¶è°ƒç”¨`_txc_aio_submit()`æäº¤IOï¼Œç„¶åé€€å‡º`_txc_state_proc()`ã€‚ä¹‹åaioå®Œæˆçš„æ—¶å€™aio_threadçº¿ç¨‹ä¼šè°ƒç”¨å›è°ƒå‡½æ•°`txc_aio_finish()`å†æ¬¡è¿›å…¥çŠ¶æ€æœº
> `_txc_aio_submit()`çš„è°ƒç”¨æ ˆä¸ºï¼š
> `BlueStore::_txc_aio_submit()` -> `BlockDevice::aio_submit()`ï¼ˆä¸åŒè®¾å¤‡ç±»å‹å„è‡ªå®ç°ï¼‰
> å°†aioæäº¤åˆ°å†…æ ¸libaioé˜Ÿåˆ—ã€‚

- **deferred write**
å•çº¯çš„deferred writeæ²¡æœ‰éœ€è¦æäº¤çš„ioï¼Œè·³è¿‡ifä¸­çš„å¤„ç†ç›´æ¥æ»‘å…¥ä¸‹ä¸€ä¸ªcaseï¼ˆæ²¡æœ‰çŠ¶æ€æ›´æ”¹ï¼‰.
ä¹Ÿå³è™½ç„¶deferred writeæ²¡æœ‰å°†çŠ¶æ€è°ƒæ•´ä¸ºSTATE_AIO_WAITï¼Œä½†ä»ç„¶è¿›è¡Œäº†å…¶å¯¹åº”çš„åç»­çš„ä¿åºå¤„ç†ã€‚

![[Pasted image 20230214173353.png]]


#### ğŸ“STATE_AIO_WAIT
è°ƒç”¨`_txc_finish_io()`è¿›è¡Œkväº‹åŠ¡çš„==**ä¿åºå¤„ç†**==ï¼Œä¿è¯æŒ‰é¡ºåºè¿›è¡Œkväº‹åŠ¡çš„å¤„ç†ã€‚
åŒä¸€æ¬¡å†™è¯·æ±‚çš„åœ°å€æ˜¯ä¸é‡å çš„ï¼Œå› æ­¤ä¸ç”¨è€ƒè™‘åŒä¸€æ¬¡å†™è¯·æ±‚çš„ä¸åŒioçš„é¡ºåºæ€§ã€‚è€Œå¤šæ¬¡å†™è¯·æ±‚åˆ™æœ‰å¯èƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„åŒä¸€åœ°å€è¿›è¡Œæ“ä½œï¼Œè€Œaioçš„å®Œæˆåˆæœ‰å¯èƒ½æ˜¯ä¹±åºçš„ï¼Œå› æ­¤éœ€è¦ä¿è¯**kväº‹åŠ¡æŒ‰è¯·æ±‚é¡ºåº**è¿›è¡Œã€‚

> ä¸ºä»€ä¹ˆä¸åœ¨ä¸åŒè¯·æ±‚çš„aioæäº¤æ—¶å°±ä¿åºï¼Ÿ
> é™¤äº†è€ƒè™‘æ•ˆç‡ä¹‹å¤–ï¼Œsimple writeéƒ½æ˜¯å†™ä¸€ä¸ªæ–°åˆ†é…çš„blockï¼Œæ²¡æœ‰å†²çªï¼Œå³ä½¿æ˜¯COWä¹Ÿæ˜¯æ–°åˆ†é…çš„ç©ºé—´ï¼Œå…ˆå†™blockå†åŒæ­¥å…ƒæ•°æ®ä¿¡æ¯ï¼Œåªè¦ä¿è¯å…ƒæ•°æ®æ›´æ–°ï¼ˆkvæ›´æ–°ï¼‰æŒ‰ç…§é¡ºåºè¿›è¡Œï¼Œä¸ä¼šé€ æˆæ•°æ®å‡ºé”™ã€‚
> è€Œdeferred writeå°±æ˜¯å…ˆå†™åˆ°kvdbä¸­ã€‚

##### _ txc_finish_io()ä¿åºçš„å®ç°

```ad-important
title:OpSequencer osr
å½“å‰pgï¼ˆCollectionï¼‰çš„OpSequenceræˆå‘˜

bluestoreé‡Œé€šè¿‡OpSequenceræ¥ä¿è¯kväº‹åŠ¡çš„é¡ºåºæ€§ï¼Œä¸€ä¸ªpgå¯¹åº”ä¸€ä¸ªOpSequencerã€‚
å†™è¯·æ±‚åˆ°è¾¾BlueStoreåä¼šè·å–è¿™ä¸ªpgå’Œå…¶å¯¹åº”çš„OpSequencerçš„æŒ‡é’ˆï¼Œåœ¨queue_transaction()ä¸­åˆ›å»ºTransContextå¯¹è±¡ï¼ˆtxcï¼‰æ—¶å°†å½“å‰è¯·æ±‚çš„txcæ·»åŠ åˆ°OpSequencerçš„äº‹åŠ¡åˆ—è¡¨ä¸­ï¼Œåç»­kväº‹åŠ¡å°†æŒ‰ç…§è¿™ä¸ªäº‹åŠ¡åˆ—è¡¨çš„é¡ºåºä¸²è¡Œè¿›è¡Œã€‚


ä¹Ÿå³**OpSequencerç»´æŠ¤äº†ä¸€ä¸ªæŒ‰ç…§pgè¯·æ±‚åˆ°è¾¾æ—¶é—´æ’åºçš„äº‹åŠ¡åˆ—è¡¨**ã€‚
```
è¿›å…¥`_txc_finish_io()`åï¼Œé¦–å…ˆè·å–osrå¹¶åŠ é”ï¼Œç„¶åå°†å½“å‰txcçš„çŠ¶æ€å˜æ›´ä¸ºSTATE_IO_DONEï¼Œæ ‡å¿—æ­¤æ—¶aioå·²å®Œæˆã€‚éšåè·å–å½“å‰txcåœ¨osrä¸­çš„ä½ç½®ï¼Œå‘å‰éå†osrã€‚
- å¦‚æœåœ¨å‰é¢é‡åˆ°æ²¡æœ‰åˆ°è¾¾STATE_IO_DONEçŠ¶æ€çš„txcåˆ™é˜»å¡å½“å‰çš„txcï¼Œç›´æ¥é€€å‡ºï¼Œç­‰å¾…å‰é¢çš„txcå”¤é†’ï¼›
- å¦‚æœå‰é¢åœ¨å‰é¢é‡åˆ°å·²ç»åˆ°è¾¾STATE_IO_DONEä¹‹åçŠ¶æ€çš„txcï¼Œé‚£ä¹ˆå–å¾—å…¶åçš„txcï¼Œç»“æŸå¾ªç¯ï¼ˆæ­¤å‰çš„æ‰€æœ‰txcä¸€å®šå·²ç»è¿›å…¥kvçš„å¤„ç†äº†ï¼‰ã€‚éå†å”¤é†’åé¢å·²åˆ°è¾¾STATE_IO_DONEçŠ¶æ€çš„txcï¼Œé‡æ–°è¿›å…¥çŠ¶æ€æœºå¤„ç†ï¼Œç›´åˆ°é‡åˆ°è¿˜æ²¡è¿›å…¥STATE_IO_DONE çŠ¶æ€çš„txcç»“æŸéå†ã€‚
![[Pasted image 20230214174250.png]]

#### ğŸ“STATE_IO_DONE
é…ç½®é¡¹bluestore_sync_submit_transactionï¼ˆboolï¼‰æ§åˆ¶kvä¿¡æ¯æ˜¯å¦åŒæ­¥æäº¤åˆ°kvdbä¸­å¹¶æŒä¹…åŒ–ã€‚
![[Pasted image 20230214174408.png]]
- éåŒæ­¥æäº¤çŠ¶æ€å˜æ›´ä¸º==**STATE_KV_QUEUED**==ï¼›
- åŒæ­¥æäº¤çŠ¶æ€å˜æ›´ä¸º==**STATE_KV_SUBMITTED**==ï¼›

ç›®å‰çœ‹ä¸¤ç§æäº¤çŠ¶æ€çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼š
- éåŒæ­¥æäº¤æ˜¯å¾…txcåŠ å…¥åˆ°kv_queueåç”±ky_sync_threadçº¿ç¨‹å¤„ç†æäº¤ï¼Œè°ƒç”¨`db->submit_transaction()`ï¼›
- åŒæ­¥æäº¤æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­ã€txcåŠ å…¥åˆ°kv_queueä¹‹å‰ï¼ˆè¿›å…¥kv_sync_threadçº¿ç¨‹ä¹‹å‰ï¼‰å°±ç›´æ¥å¤„ç†æäº¤äº†ï¼Œåœ¨kv_sync_threadä¸­åªæ›´æ–°äº†æ€§èƒ½å‚æ•°ã€‚

ä¸¤ç§æƒ…å†µéƒ½ä¼šå°†txcåŠ å…¥åˆ°kv_queueé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”ç”±kv_condå»é€šçŸ¥kv_sync_threadå»åŒæ­¥ioå’Œå…ƒæ•°æ®ã€‚éåŒæ­¥æäº¤è¿˜å°†txcåŠ å…¥åˆ°äº†kv_queue_unsubmittedé˜Ÿåˆ—ä¸­ã€‚çŠ¶æ€è°ƒæ•´ç»“æŸåç›´æ¥é€€å‡ºå‡½æ•°ã€‚

##### dbå¤„ç†çš„å‡ ä¸ªé‡è¦çº¿ç¨‹å’Œé˜Ÿåˆ—

![[Pasted image 20230214174510.png]]

#### ğŸ“STATE_KV_QUEUED
è¯¥çŠ¶æ€æ˜¯åœ¨`kv_sync_thread()`çº¿ç¨‹å’Œ`kv_finalize_thread()`ä¸­è¿›è¡Œå¤„ç†çš„ï¼š
å°†kv_queueä¸­çš„txcåŠ å…¥åˆ°kv_committingä¸­ï¼Œå¦‚æœtxcçš„çŠ¶æ€ä¸ºSTATE_KV_QUEUEDï¼Œè°ƒç”¨`db->submit_transaction()`æäº¤ç»™kvdbæ‰§è¡Œï¼Œå¹¶è®¾ç½®å½“å‰txcçš„çŠ¶æ€ä¸º==**STATE_KV_SUBMITTED**==ã€‚
![[Pasted image 20230207153305.png]]

![[Pasted image 20230214174638.png]]

- **BlueStore::kv_sync_thread()**
å°†**kv_queue**ä¸­çš„txcåŠ å…¥åˆ°kv_committingä¸­ï¼Œå¦‚æœtxcçš„çŠ¶æ€ä¸ºSTATE_KV_QUEUEDï¼Œè°ƒç”¨`db->submit_transaction()`æäº¤ç»™kvdbæ‰§è¡Œï¼Œå¹¶è®¾ç½®å½“å‰txcçš„çŠ¶æ€ä¸º**STATE_KV_SUBMITTED**ã€‚
ç»è¿‡ä»¥ä¸Šå¤„ç†åï¼Œè°ƒç”¨`db->submit_transaction_sync()`å®Œæˆkvdbçš„åŒæ­¥æ›´æ–°ã€‚
ç„¶åå°†kv_committingé˜Ÿåˆ—ä¸­çš„txcè½¬ç§»åˆ°kv_committing_to_finalizeé˜Ÿåˆ—ä¸­ç­‰å¾…åœ¨`kv_finalize_thread()`çº¿ç¨‹ä¸­ç»§ç»­å¤„ç†ã€‚

- **BlueStore::kv_finalize_thread()**
éå†é˜Ÿåˆ—kv_committing_to_finalizeï¼Œé‡æ–°è¿›å…¥`_txc_state_proc()`è¿›è¡ŒçŠ¶æ€æœºå¤„ç†ï¼Œå¹¶å°†å½“å‰txcå‡ºé˜Ÿã€‚

#### ğŸ“STATE_KV_SUBMITTED
å½“txcä»¥è¯¥çŠ¶æ€å›åˆ°äº‹åŠ¡å¤„ç†å‡½æ•°æ—¶ï¼Œå°†è°ƒç”¨`txc_committed_kv()`å‡½æ•°å°†çŠ¶æ€è®¾ç½®ä¸º==**STATE_KV_DONE**==ï¼Œå¹¶ä¸”å›è°ƒfinisherçº¿ç¨‹ã€‚
ç„¶åç›´æ¥æ»‘å…¥ä¸‹ä¸€ä¸ªcase
![[Pasted image 20230207150748.png]]

#### ğŸ“STATE_KV_DONE
- å¦‚æœåªæœ‰**simple write**ï¼Œå…¨éƒ¨æµç¨‹å·²ç»èµ°å®Œï¼Œæ— éœ€è€ƒè™‘å»¶è¿Ÿå†™çš„å†…å®¹ï¼Œç›´æ¥å°†çŠ¶æ€è®¾ç½®ä¸º==**STATE_FINISHING**==ï¼Œå¹¶ä»¥è¯¥çŠ¶æ€è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯åŒ¹é…çŠ¶æ€ï¼Œè¿›è¡Œæœ€åçš„å¤„ç†ã€‚
- å¯¹äºå«æœ‰**deferred write**çš„txcï¼Œæ­¤æ—¶å°†ä¼štxcçŠ¶æ€æ›´æ–°ä¸º==**STATE_DEFFERRED_QUEUED**==ï¼Œå¹¶è¿›å…¥`_deferred_queue()`ä¸­è¿›è¡Œdeferred aioçš„å¤„ç†ï¼ˆä»dbå†™å›blockï¼‰ã€‚
![[Pasted image 20230214175205.png]]

##### deferred write

```ad-important
title:BlueStore::DeferredBatch
å’ŒTransContextä¸€æ ·ï¼ŒDeferredBatchï¼ˆdbhï¼‰ä¹Ÿç»§æ‰¿è‡ªAioContextï¼Œè®°å½•äº†å»¶è¿Ÿå†™çš„ç›¸å…³ioæ•°æ®ã€‚ä¸€ä¸ªdbhç»´æŠ¤äº†ä¸€ä¸ªtxcåˆ—è¡¨ï¼Œç”¨äºä¿è¯åŒä¸€ä¸ªpgä¸Šå»¶è¿Ÿå†™äº‹åŠ¡çš„é¡ºåºæ€§ã€‚
```

```ad-important
title: BlueStore::deferred_queue
ä¸€ä¸ªOSDä¸Šæ‰€æœ‰æœ‰å¾…æ‰§è¡Œçš„deferred writeçš„OpSequenceråˆ—è¡¨ã€‚
OpSequencerè¿˜æœ‰ä¸¤ä¸ª*DeferredBatchæˆå‘˜deferred_pendingå’Œdeferred_runningã€‚
```

BlueStoreé€šè¿‡ä»¥ä¸Šç»“æ„æ¥ä¿è¯deferred writeçš„é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸€ä¸ªå»¶è¿Ÿå†™äº‹åŠ¡éƒ½è¦åˆ°deferred_pendingä¸­è¿›è¡Œæ’é˜Ÿï¼Œ` _deferred_queue()`å°±æ˜¯è¿›è¡Œè¿™ä¸ªå¤„ç†ã€‚åœ¨ `_deferred_queue()`æœ€åä¼šè¿›å…¥åˆ°`_deferred_submit_unlock()`å‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°ä¸­ä¼šä¾æ¬¡å‡†å¤‡ioå¹¶åœ¨æœ€åè¿›è¡Œä¸€æ¬¡æ€§æäº¤ã€‚
aioå›åº”åï¼Œè°ƒç”¨DeferredBatchå›è°ƒå‡½æ•°`_deferred_aio_finish()`ï¼Œæœ€ç»ˆå½“å‰txcå˜æ›´ä¸º==**STATE_DEFERRED_CLEANUP**==ã€‚å¹¶å°†å½“å‰çš„dbhåŠ å…¥åˆ°deferred_done_queueé˜Ÿåˆ—ä¸­ã€‚
![[Pasted image 20230214175626.png]]

**deferred io æäº¤çš„æ—¶æœº**
![[Pasted image 20230214175723.png]]
- **`_deferred_queue()`**
æ¯å½“ä¸€ä¸ªtxcè¿›å…¥åˆ°è¯¥å‡½æ•°ä¸€æ¬¡ï¼Œ`deferred_queue_size+1`
> å½“deferred_aggressiveä¸ºé0ä¸”æ²¡æœ‰åœ¨è¿è¡Œçš„dbhï¼Œæäº¤æ‰€æœ‰çš„deferred ioã€‚ä½†ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šèµ°åˆ°è¿™ä¸€æ­¥
- **`kv_finalize_thread()`**
åœ¨deferred_aggressiveä¸º0çš„æƒ…å†µä¸‹ï¼Œæ£€æŸ¥deferred_queue_sizeçš„å¤§å°ï¼Œå¦‚æœå·²ç»å¤§äºdeferred_batch_opsï¼Œåˆ™æäº¤deferred ioã€‚
![[Pasted image 20230214175907.png]]

![[Pasted image 20230214180007.png]]
- **BlueStore::kv_sync_thread()**
> - **deferred_done_queue**ï¼šå¦‚æœéœ€è¦è¿›è¡Œforce flushæ“ä½œï¼Œflushåå°†å…¶æ”¾å…¥deferred_stableä¸´æ—¶é˜Ÿåˆ—ä¸­ï¼Œå¹¶åœ¨åé¢å¯¹deferred_stableçš„å¤„ç†æ—¶ä¸€èµ·è¿›è¡Œï¼Œå¹¶éšä¹‹åŠ å…¥åˆ°deferred_stable_finalize_queueé˜Ÿåˆ—ä¸­ï¼Œæäº¤åˆ°finalizeçº¿ç¨‹ä¸­è¿›è¡Œå¤„ç†ã€‚å¦‚æœæ²¡æœ‰ç»è¿‡force flushçš„æ“ä½œï¼Œå°†å…¶æ”¾å…¥deferred_stable_queueï¼Œä¸‹æ¬¡å¾ªç¯è¿›è¡Œå¤„ç†ã€‚
> - **deferred_stable_queue**ï¼šå¯¹äºå·²ç»è½ç›˜å®Œæ¯•çš„deferred writeï¼ˆå·²åœ¨ä¸´æ—¶é˜Ÿåˆ—deferred_stableä¸­ï¼‰ï¼Œéå†åˆ é™¤ä»–ä»¬çš„keyã€‚

ç»è¿‡ä»¥ä¸Šå¤„ç†åï¼Œè°ƒç”¨db->submit_transaction_sync()å®Œæˆkvdbçš„åŒæ­¥æ›´æ–°ã€‚
ç„¶åå°†deferred_stableå…ƒç´ è½¬ç§»åˆ°deferred_stable_finalize_queueä¸­ï¼Œç­‰å¾…åœ¨kv_finalize_thread()çº¿ç¨‹ä¸­ç»§ç»­å¤„ç†ã€‚

- **BlueStore::kv_finalize_thread()**
éå†dbhä¸Šçš„txcåˆ—è¡¨ï¼Œé‡æ–°ä¾æ¬¡è¿›å…¥_txc_state_procè¿›è¡ŒçŠ¶æ€æœºå¤„ç†ï¼Œå¹¶æ¸…ç©º

deferred writeçš„kväº‹åŠ¡å¤„ç†æµç¨‹ï¼š
![[deferred æ—¶åº.drawio 1.png]]

#### ğŸ“STATE_DEFFERED_CLEANUP
txcä»¥è¯¥çŠ¶æ€å›åˆ°çŠ¶æ€æœºï¼Œæ ‡å¿—ç€deferred writeç›¸å…³çš„WALä¿¡æ¯å·²è¢«æ¸…é™¤ï¼ˆdbä¸­çš„ç›¸å…³kvæ•°æ®ï¼‰ã€‚
è¿™åªæ˜¯ä¸€ä¸ªçŸ­æš‚çš„çŠ¶æ€ï¼Œè®°å½•äº†å»¶è¿Ÿæ•°æ®ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰è¿›è¡Œå…¶ä»–æ“ä½œï¼Œç›´æ¥å°†çŠ¶æ€å˜æ›´ä¸º==**STATE_FINISHING**==ï¼Œæ»‘å…¥ä¸‹ä¸€ä¸ªcaseã€‚
ï¼ˆcaseçŠ¶æ€åæ²¡æœ‰breakæˆ–returnç»“æŸï¼Œç›´æ¥è¿›å…¥STATE_FINISHINGï¼‰
![[Pasted image 20230214180426.png]]

#### ğŸ“STATE_FINISHING
æœ€åé˜¶æ®µï¼ŒçŠ¶æ€å˜æ›´ä¸º==**STATE_DONE**==ã€‚æµç¨‹ç¡®è®¤å†™å…¥åˆ°è®¾å¤‡ä¸­çš„æ“ä½œå®Œæˆï¼Œå°†ä¿®æ”¹åœ¨SharedBlobï¼Œé‡Šæ”¾ä¸éœ€è¦çš„å†…å­˜æ•°æ®ï¼Œå¦‚æœè¿˜æœ‰deferredIOä¹Ÿä¼šæäº¤ã€‚

#### ğŸ“STATE_DONE
æ ‡è¯†æ•´ä¸ªIOå®Œæˆ

#### ä¸¤ä¸ªçº¿ç¨‹çš„æ€»ç»“
kv_sync_thread()å’Œkv_finalize_thread()
åœ¨bluestoreåˆ›å»ºçš„æ—¶å€™åˆå§‹åŒ–è¿™ä¸¤ä¸ªçº¿ç¨‹ï¼Œmountæ—¶é€šè¿‡_kv_start()å‡½æ•°åˆ›å»ºè¿™ä¸¤ä¸ªçº¿ç¨‹ã€‚

##### BlueStore::kv_sync_thread()

åŒæ­¥çº¿ç¨‹ï¼Œå¾ªç¯å¤„ç†ä¸‰ä¸ªé˜Ÿåˆ—ï¼škv_queueã€deferred_done_queueã€deferred_stable_queue

![[Pasted image 20230215093000.png]]

- **kv_queue**ï¼šå°†kv_queueä¸­çš„txcåŠ å…¥åˆ°kv_committingä¸­ï¼Œå¦‚æœtxcçš„çŠ¶æ€ä¸ºSTATE_KV_QUEUEDï¼Œè°ƒç”¨db->submit_transaction()æäº¤ç»™kvdbæ‰§è¡Œï¼Œå¹¶è®¾ç½®å½“å‰txcçš„çŠ¶æ€ä¸ºSTATE_KV_SUBMITTEDã€‚

- **deferred_done_queue**ï¼šå¦‚æœéœ€è¦è¿›è¡Œforce flushæ“ä½œï¼Œflushåå°†å…¶æ”¾å…¥deferred_stableä¸´æ—¶é˜Ÿåˆ—ä¸­ï¼Œå¹¶åœ¨åé¢å¯¹deferred_stableçš„å¤„ç†æ—¶ä¸€èµ·è¿›è¡Œï¼Œå¹¶éšä¹‹åŠ å…¥åˆ°deferred_stable_finalize_queueé˜Ÿåˆ—ä¸­ï¼Œæäº¤åˆ°finalizeçº¿ç¨‹ä¸­è¿›è¡Œå¤„ç†ã€‚å¦‚æœæ²¡æœ‰ç»è¿‡force flushçš„æ“ä½œï¼Œå°†å…¶æ”¾å…¥deferred_stable_queueï¼Œä¸‹æ¬¡å¾ªç¯è¿›è¡Œå¤„ç†ã€‚

- **deferred_stable_queue**ï¼šå¯¹äºå·²ç»è½ç›˜å®Œæ¯•çš„deferred writeï¼ˆå·²åœ¨ä¸´æ—¶é˜Ÿåˆ—deferred_stableä¸­ï¼‰ï¼Œéå†åˆ é™¤ä»–ä»¬çš„keyã€‚

ç»è¿‡ä»¥ä¸Šå¤„ç†åï¼Œè°ƒç”¨`db->submit_transaction_sync()`å®Œæˆkvdbçš„åŒæ­¥æ›´æ–°ï¼Œè½ç›˜ã€‚
ç„¶åï¼š
- å°†kv_committingé˜Ÿåˆ—ä¸­çš„txcè½¬ç§»åˆ°kv_committing_to_finalizeé˜Ÿåˆ—ä¸­ï¼›
- å°†deferred_stableé˜Ÿåˆ—ä¸­çš„dbhè½¬ç§»åˆ°deferred_stable_finalize_queueä¸­ï¼›
ç­‰å¾…åœ¨kv_finalize_thread()çº¿ç¨‹ä¸­ç»§ç»­å¤„ç†ã€‚

##### BlueStore::kv_finalize_thread()
æ¸…ç†çº¿ç¨‹ï¼Œæ§åˆ¶txcé‡æ–°è¿›å…¥çŠ¶æ€æœºã€‚
å¤„ç†ä¸¤ä¸ªä¸ªé˜Ÿåˆ—kv_committing_to_finalizeå’Œdeferred_stable_to_finalize

- **kv_committing_to_finalize**ï¼šéå†é˜Ÿåˆ—ï¼Œé‡æ–°è¿›å…¥_txc_state_proc()è¿›è¡ŒçŠ¶æ€æœºå¤„ç†ï¼Œå¹¶å°†å½“å‰txcå‡ºé˜Ÿã€‚
![[Pasted image 20230215091642.png]]
- **deferred_stable_finalize**ï¼šéå†dbhä¸Šçš„txcåˆ—è¡¨ï¼Œé‡æ–°ä¾æ¬¡è¿›å…¥_txc_state_procè¿›è¡ŒçŠ¶æ€æœºå¤„ç†ï¼Œå¹¶æ¸…ç©ºã€‚
![[Pasted image 20230215091701.png]]
- **æ§åˆ¶deferred ioæäº¤** -> deferred_queue_sizeã€deferred_aggressive


### æµç¨‹ç¤ºæ„å›¾

![[8416bf7672044ba59050de10ddcbea3d.png]]

![[çŠ¶æ€æœº.png]]
![[Pasted image 20230214180510.png]]